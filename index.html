<!DOCTYPE html>
<html>

<head>
    <title>Bannergress Banner Mapper</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .flex-container {
            display: flex;
            height: 100%;
        }

        #map {
            flex-grow: 1;
        }

        .nav-area {
            width: 200px;
            /* Adjust as needed */
            background-color: #f8f9fa;
            padding: 1em;
            box-shadow: -1px 0 5px rgba(0, 0, 0, 0.1);
        }

        .nav-area button {
            margin-top: 1em;
            width: 100%;
        }

        .leaflet-popup-content img {
            max-width: 300px;
        }

        #show-banners {
            position: relative;
        }

        #loading-spinner {
            display: none;
            border: 5px solid #0099ff;
            border-top: 5px solid #000000;
            border-radius: 50%;
            width: 5px;
            height: 5px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="flex-container">

        <div id="map"></div>
        <div class="nav-area">
            <p>This page can display lots of banners from <a href="https://bannergress.com"
                    target="_blank">Bannergress</a> on a single
                map at the same time.</p>
            <p>It can also display all the banners from a place, such as a city or a country, by pasting the place's
                "browse" URL below.</p>
            <p>Here are some suggestion: 
                <a href="#" class="example-place" data-id="london-6549">London</a>,
                <a href="#" class="example-place" data-id="lisbon-1eae">Lisbon</a>,
                <a href="#" class="example-place" data-id="porto-9b95">Porto</a>,
                <a href="#" class="example-place" data-id="hanover-6716">Hannover</a>, or
                <a href="#" class="example-banners" data-id="recurse-aberdeen-595b,artistic-aberdeen-ca16,resistance-aberdeen-874e">some missions in Aberdeen that make a good route</a>.</p>

            <label for="banner-links">Paste your bannergress links here:</label>
            <textarea id="banner-links"
                style="width: 100%; height: 200px;"></textarea>
            <div>
                <button id="show-banners">
                    Show banners
                    <div id="loading-spinner"></div>
                </button>
                <button id="clear-banners">Clear banners</button>
            </div>

            <p>
                This is not affiliated with Niantic, Inc., Ingress, or Bannergress. Raise issues on <a href="https://github.com/simbabque/ingress-banner-mapper/issues">Github</a>.
            </p>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
        <script>

            // Initialise the map - we start in London
            var map = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // FeatureGroup to keep all banners visible
            const allBanners = L.featureGroup();

            // Event listener for the "Show banners" button
            document.getElementById("show-banners").addEventListener("click", async () => {
                // Show the loading spinner
                document.getElementById('loading-spinner').style.display = 'inline-block';

                const urlsToFetch = [];
                for (const url of document.getElementById("banner-links").value.split('\n')) {
                    // ignore if it doesn't look like a bannergress.com url
                    if (!url.includes('bannergress.com')) {
                        continue;
                    }

                    // if it's a browse url, resolve it to the list of banners
                    if (url.includes('/browse/')) {
                        const banners = await resolvePlaceURL(url);
                        urlsToFetch.push(...banners);
                    } else {
                        urlsToFetch.push(url);
                    }
                }

                // Fetch all URLs concurrently
                Promise.all(urlsToFetch.map(url => fetchJsonData(apiURL(url))))
                    .then(dataArray => {
                        allBanners.addTo(map);
                        map.fitBounds(allBanners.getBounds());
                        // Hide the loading spinner
                        document.getElementById('loading-spinner').style.display = 'none';

                    })
                    .catch(error => {
                        console.error('One or more fetch calls failed:', error);

                        // Hide the loading spinner
                        document.getElementById('loading-spinner').style.display = 'none';
                    });
            });

            // Event listener for the "Clear banners" button
            document.getElementById("clear-banners").addEventListener("click", () => {
                allBanners.clearLayers();
                allBanners.remove();
                invocationCount = 0;
            });

            // Event listener for the example places to append their data-id as browse URLs into the textarea in a new line
            document.querySelectorAll('.example-place').forEach(place => place.addEventListener('click', (event) => {
                const textarea = document.getElementById('banner-links');
                textarea.value += `https://bannergress.com/browse/${event.target.dataset.id}\n`;
            }));

            // Event listener for the example banners to append their data-id as banner URLs into the textarea in a new line
            document.querySelectorAll('.example-banners').forEach(place => place.addEventListener('click', (event) => {
                const textarea = document.getElementById('banner-links');
                textarea.value += event.target.dataset.id.split(',').map(id => `https://bannergress.com/banner/${id}`).join('\n') + '\n';
            }));

            // Turn banner URL into API URL
            function apiURL(url) {
                return 'https://api.bannergress.com/bnrs/' + url.split('/').pop();
            }

            // Function to retrieve a single banner JSON and draw it on the map
            let invocationCount = 0;
            function fetchJsonData(url) {
                return fetch(url)
                    .then(response => response.json())
                    .then(data => allBanners.addLayer(drawBanner(data, invocationCount++)))
                    .catch(error => console.error('Error fetching JSON:', error));
            }

            // Function to turn a place into a list of banners
            function resolvePlaceURL(url) {
                // Extract the placeId from the URL
                const placeId = url.split('/').pop();

                // Fetch all banners iteratively using offset
                const fetchAllBanners = async (placeId, offset = 0, banners = []) => {
                    const apiUrl = `https://api.bannergress.com/bnrs?orderBy=created&orderDirection=DESC&online=true&placeId=${placeId}&limit=100&offset=${offset}`;

                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        const newBanners = data.map(banner => `https://bannergress.com/banner/${banner.id}`);
                        banners.push(...newBanners);

                        if (data.length === 100) {
                            return fetchAllBanners(placeId, offset + 100, banners);
                        } else {
                            return banners;
                        }
                    } catch (error) {
                        console.error('Error fetching JSON:', error);
                    }
                };

                // Fetch the data
                return fetchAllBanners(placeId);
            }

            // Colours for the banner routes
            const colours = [
                "#FF0000", // Red
                "#FF7F00", // Orange
                "#0000FF", // Blue
                "#7FFF00", // Chartreuse
                "#00FFFF", // Cyan
                "#00FF7F", // SpringGreen
                "#007FFF", // Azure
                "#7F00FF", // Violet
                "#FF00FF", // Magenta
                "#FF007F", // Rose
                "#FF4500", // OrangeRed
                "#FFD700", // Gold
                "#FF8C00", // DarkOrange
                "#8B4513", // SaddleBrown
                "#32CD32", // LimeGreen
                "#4682B4", // SteelBlue
                "#9932CC", // DarkOrchid
                "#8A2BE2",  // BlueViolet
                "#FFFF00", // Yellow
                "#00FF00", // Lime
            ];

            // Function to draw a banner on the map
            function drawBanner(bannerData, invocationCount) {
                const colour = colours[invocationCount % colours.length];
                const lowOpacity = 0.2;
                const regularOpacity = 0.6;
                const fullOpacity = 1;
                const latLongPairs = [];
                try {
                    Object.values(bannerData.missions).forEach(mission => {
                        mission.steps.forEach(step => {
                            if (step.poi && step.poi.type !== "unavailable") {
                                const { latitude, longitude } = step.poi;
                                latLongPairs.push([latitude, longitude]);
                            }
                        });
                    });
                } catch (e) {
                    console.log(bannerData);
                    console.error(e);
                };
                const polyline = L.polyline(latLongPairs, { color: colour, opacity: regularOpacity }).addTo(allBanners);
                const arrowSymbol = L.polylineDecorator(polyline, {
                    patterns: [
                        {
                            offset: '10', repeat: '50', symbol: L.Symbol.arrowHead({
                                pixelSize: 10, polygon: false, pathOptions: { color: colour, opacity: regularOpacity }
                            })
                        }
                    ]
                }).addTo(allBanners);
                // featureGroup.addLayer(polyline);
                const length = Number(bannerData.lengthMeters / 1000).toPrecision(2);
                polyline.bindPopup(`
                <a href="https://bannergress.com/banner/${bannerData.id}">${bannerData.title}</a> (${length}km)
                <br/>
                <img src="https://api.bannergress.com/${bannerData.picture}" width="300">
            `);

                // Change opacity on hover
                [polyline, arrowSymbol].forEach(element => {
                    element.on('mouseover', () => {
                        polyline.setStyle({ opacity: fullOpacity });
                        arrowSymbol.setStyle({ opacity: fullOpacity });
                        allBanners.eachLayer(layer => {
                            if (layer !== polyline && layer !== arrowSymbol) {
                                layer.setStyle({ opacity: lowOpacity });
                            }
                        });
                    });

                    element.on('mouseout', () => {
                        allBanners.eachLayer(layer => {
                            layer.setStyle({ opacity: regularOpacity });
                        });
                    });
                });

                allBanners.addLayer(polyline);
                return polyline;
            }

        </script>
</body>

</html>